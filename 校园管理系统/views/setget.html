<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ¡å›­ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="style1.css">
  <link rel="stylesheet" href="style2.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="sidebar-layout">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>æ ¡å›­ç®¡ç†ç³»ç»Ÿ</h2>
        <p>åŸºäºåŒºå—é“¾çš„å­¦ç”Ÿä¿¡æ¯ç®¡ç†</p>
      </div>
      <ul class="sidebar-menu">
        <li>
          <a href="#grades-section" class="active">
            <i class="fas fa-graduation-cap menu-icon"></i>
            <span>æˆç»©ç®¡ç†</span>
          </a>
        </li>
        <li>
          <a href="#tuition-section">
            <i class="fas fa-money-bill-wave menu-icon"></i>
            <span>å­¦è´¹ç®¡ç†</span>
          </a>
        </li>
        <li>
          <a href="#student-info-section">
            <i class="fas fa-user-graduate menu-icon"></i>
            <span>å­¦ç”Ÿä¿¡æ¯</span>
          </a>
        </li>
        <li>
          <a href="#search-section">
            <i class="fas fa-search menu-icon"></i>
            <span>ä¿¡æ¯æŸ¥è¯¢</span>
          </a>
        </li>
        <!-- æ·»åŠ æ•™å¸ˆå·¥èµ„ç®¡ç†èœå•é¡¹ -->
        <li>
          <a href="#teacher-salary-section">
            <i class="fas fa-chalkboard-teacher menu-icon"></i>
            <span>æ•™å¸ˆå·¥èµ„ç®¡ç†</span>
          </a>
        </li>
        <li>
          <a href="#statistics-section">
            <i class="fas fa-chart-bar menu-icon"></i>
            <span>ç»Ÿè®¡åˆ†æ</span>
          </a>
        </li>
        <!-- æ–°å¢AIå¯¹è¯é€‰é¡¹ -->
        <li>
          <a href="#ai-chat-section">
            <i class="fas fa-robot menu-icon"></i>
            <span>AIåŠ©æ‰‹</span>
          </a>
        </li>
        <li>
          <a href="#system-section">
            <i class="fas fa-cog menu-icon"></i>
            <span>ç³»ç»Ÿç®¡ç†</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <div class="content-wrapper">
        <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="connection-status">
          <div class="status-indicator">
            <span id="blockchainIcon" class="status-icon">ğŸ”„</span>
            <span>åŒºå—é“¾è¿æ¥: </span>
            <span id="blockchainStatusText" class="connecting">è¿æ¥ä¸­...</span>
          </div>
          <div class="status-indicator">
            <span id="databaseIcon" class="status-icon">ğŸ”„</span>
            <span>æ•°æ®åº“è¿æ¥: </span>
            <span id="databaseStatusText" class="connecting">è¿æ¥ä¸­...</span>
          </div>
        </div>

        <!-- æˆç»©ç®¡ç†éƒ¨åˆ† -->
        <section id="grades-section" class="active">
          <div class="content-card">
            <h2><i class="fas fa-graduation-cap"></i> æˆç»©å½•å…¥</h2>
            <div class="form-group">
              <label for="studentId">å­¦å·:</label>
              <input type="number" id="studentId" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            
            <div class="form-group">
              <label>è¯¾ç¨‹ä¸æˆç»©:</label>
              <div id="subjects-container">
                <!-- è¯¾ç¨‹è¡Œå°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
              </div>
              <button id="addSubject">æ·»åŠ è¯¾ç¨‹</button>
              <button onclick="setValue()">æäº¤æˆç»©</button>
            </div>
            
          
            <span id="setError" class="error"></span>
            <pre id="transactionInfo"></pre>
          </div>

          <!-- æ‰¹é‡å¯¼å…¥æˆç»©éƒ¨åˆ† -->
          <div class="content-card">
            <h2><i class="fas fa-file-excel"></i> æ‰¹é‡å¯¼å…¥æˆç»©</h2>
            <div class="form-group">
              <label for="excelFile">é€‰æ‹©Excelæ–‡ä»¶:</label>
              <input type="file" id="excelFile" accept=".xlsx, .xls">
            </div>
            
            <div class="button-container">
              <button onclick="previewExcel()">é¢„è§ˆæ•°æ®</button>
              <button id="importButton" onclick="importExcelData()" disabled>å¯¼å…¥æ•°æ®</button>
            </div>
            
            <span id="batchError" class="error"></span>
            <pre id="batchTransactionInfo"></pre>
            
            <div id="previewContainer" class="preview-container" style="display: none;">
              <h3>æ•°æ®é¢„è§ˆ</h3>
              <div class="preview-table">
                <table id="previewTable"></table>
              </div>
            </div>
          </div>
        </section>

        <!-- å­¦è´¹ç®¡ç†éƒ¨åˆ† -->
        <section id="tuition-section">
          <div class="content-card">
            <h2><i class="fas fa-search-dollar"></i> å­¦è´¹çŠ¶æ€æŸ¥è¯¢</h2>
            <div class="form-group">
              <label for="tuitionQueryStudentId">å­¦å·:</label>
              <input type="number" id="tuitionQueryStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            
            <div class="button-container">
              <button onclick="checkTuitionStatus()">æŸ¥è¯¢å­¦è´¹çŠ¶æ€</button>
            </div>
            
            <span id="tuitionQueryError" class="error"></span>
            <div id="tuitionQueryStatus" class="status-message"></div>
          </div>
          
          <div class="content-card">
            <h2><i class="fas fa-money-bill-wave"></i> å­¦è´¹ç¼´çº³</h2>
            <div class="form-group">
              <label for="payTuitionStudentId">å­¦å·:</label>
              <input type="number" id="payTuitionStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            
            <div class="button-container">
              <button onclick="payTuition()">ç¼´çº³å­¦è´¹</button>
            </div>
            
            <span id="payTuitionError" class="error"></span>
            <div id="payTuitionStatus" class="status-message"></div>
            <pre id="payTuitionTransactionInfo"></pre>
          </div>
          
          <!-- æ–°å¢åˆçº¦ä½™é¢ç®¡ç†å¡ç‰‡ -->
          <div class="content-card">
            <h2><i class="fas fa-wallet"></i> åˆçº¦ä½™é¢ç®¡ç†</h2>
            <div class="contract-balance-info">
              <div id="contractBalance" class="balance-display">åˆçº¦ä½™é¢: åŠ è½½ä¸­...</div>
              <button onclick="getContractBalance()" class="refresh-button">
                <i class="fas fa-sync-alt"></i> åˆ·æ–°ä½™é¢
              </button>
            </div>
            
            <div class="admin-section">
              <button onclick="withdrawFunds()" class="withdraw-button">æå–å…¨éƒ¨ä½™é¢</button>
              <span id="withdrawError" class="error"></span>
              <div id="withdrawStatus" class="status-message"></div>
              <pre id="withdrawTransactionInfo"></pre>
            </div>
          </div>
        </section>

        <!-- å­¦ç”Ÿä¿¡æ¯éƒ¨åˆ† -->
        <section id="student-info-section">
          <div class="content-card">
            <h2><i class="fas fa-user-graduate"></i> å­¦ç”ŸåŸºæœ¬ä¿¡æ¯å½•å…¥</h2>
            <div class="form-group">
              <label for="infoStudentId">å­¦å·:</label>
              <input type="number" id="infoStudentId" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            
            <div class="form-group">
              <label for="studentName">å§“å:</label>
              <input type="text" id="studentName" placeholder="è¯·è¾“å…¥å§“å">
            </div>
            
            <div class="form-group">
              <label for="studentGender">æ€§åˆ«:</label>
              <select id="studentGender">
                <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                <option value="ç”·">ç”·</option>
                <option value="å¥³">å¥³</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="className">ç­çº§:</label>
              <input type="text" id="className" placeholder="è¯·è¾“å…¥ç­çº§">
            </div>
            
            <button onclick="saveStudentInfo()">ä¿å­˜ä¿¡æ¯</button>
            <span id="studentInfoError" class="error"></span>
            <div id="studentInfoResult"></div>
          </div>

          <div class="content-card">
            <h2><i class="fas fa-file-excel"></i> æ‰¹é‡å¯¼å…¥å­¦ç”Ÿä¿¡æ¯</h2>
            <div class="form-group">
              <label for="studentInfoExcelFile">é€‰æ‹©Excelæ–‡ä»¶:</label>
              <input type="file" id="studentInfoExcelFile" accept=".xlsx, .xls">
            </div>
            
            <div class="button-container">
              <button onclick="previewStudentInfoExcel()">é¢„è§ˆæ•°æ®</button>
              <button id="importStudentInfoButton" onclick="importStudentInfoExcelData()" disabled>å¯¼å…¥æ•°æ®</button>
            </div>
            
            <span id="studentInfoBatchError" class="error"></span>
            <pre id="studentInfoBatchTransactionInfo"></pre>
            
            <div id="studentInfoPreviewContainer" class="preview-container" style="display: none;">
              <h3>æ•°æ®é¢„è§ˆ</h3>
              <div class="preview-table">
                <table id="studentInfoPreviewTable"></table>
              </div>
            </div>
          </div>
        </section>

        <!-- ä¿¡æ¯æŸ¥è¯¢éƒ¨åˆ† -->
        <section id="search-section">
          <div class="content-card">
            <h2><i class="fas fa-search"></i> å­¦ç”Ÿä¿¡æ¯æŸ¥è¯¢</h2>
            <div class="search-container">
              <div class="search-group">
                <label for="searchStudentTerm">å­¦å·æˆ–å§“å:</label>
                <input type="text" id="searchStudentTerm" placeholder="è¯·è¾“å…¥å­¦å·æˆ–å§“å">
                <button onclick="searchStudentByIdOrName()">æŸ¥è¯¢</button>
              </div>
              
              <div class="search-group">
                <label for="searchClassName">ç­çº§æŸ¥è¯¢:</label>
                <input type="text" id="searchClassName" placeholder="è¯·è¾“å…¥ç­çº§åç§°">
                <button onclick="searchStudentsByClass()">æŒ‰ç­çº§æŸ¥è¯¢</button>
              </div>
            </div>
            
            <span id="searchError" class="error"></span>
            <div id="searchResults"></div>
          </div>
        </section>

        <!-- ç»Ÿè®¡åˆ†æéƒ¨åˆ† -->
        <section id="statistics-section">
          <div class="content-card">
            <h2><i class="fas fa-chart-bar"></i> æˆç»©ç»Ÿè®¡åˆ†æ</h2>
            <div class="form-group">
              <label for="statsClassName">ç­çº§:</label>
              <input type="text" id="statsClassName" placeholder="è¯·è¾“å…¥ç­çº§åç§°">
              <button onclick="generateClassStats()">ç”Ÿæˆç­çº§ç»Ÿè®¡</button>
            </div>
            
            <div id="chartsContainer">
              <!-- å›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
          </div>
        </section>

        <!-- æ–°å¢AIå¯¹è¯éƒ¨åˆ† -->
        <section id="ai-chat-section">
          <div class="content-card">
            <h2><i class="fas fa-robot"></i> AIæ™ºèƒ½åŠ©æ‰‹</h2>
            <p class="section-description">ä¸AIåŠ©æ‰‹å¯¹è¯ï¼Œè·å–æ ¡å›­ç®¡ç†ç³»ç»Ÿçš„å¸®åŠ©å’Œæ”¯æŒã€‚æ‚¨å¯ä»¥è¯¢é—®ç³»ç»ŸåŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•æˆ–æŠ¥å‘Šé—®é¢˜ã€‚</p>
            
            <div class="chat-container">
              <div class="chat-messages" id="chat-messages">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message ai-message">
                 
                  æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„çš„ AI å°åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
                  <!-- åˆ é™¤æ—¶é—´æˆ³éƒ¨åˆ† -->
                </div>
              </div>
              <div class="chat-input-container">
                <input type="text" id="user-message" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" title="å‘é€æ¶ˆæ¯">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
            
            <div class="chat-features">
              <div class="feature" onclick="askQuestion('å¦‚ä½•ä½¿ç”¨æˆç»©ç®¡ç†åŠŸèƒ½ï¼Ÿ')">
                <i class="fas fa-question-circle"></i>
                <span>ç³»ç»ŸåŠŸèƒ½å¸®åŠ©</span>
              </div>
              <div class="feature" onclick="askQuestion('è¯·æä¾›ç³»ç»Ÿä½¿ç”¨æŒ‡å—')">
                <i class="fas fa-book"></i>
                <span>ä½¿ç”¨æŒ‡å—</span>
              </div>
              <div class="feature" onclick="askQuestion('æˆ‘æƒ³æŠ¥å‘Šä¸€ä¸ªé—®é¢˜')">
                <i class="fas fa-bug"></i>
                <span>æŠ¥å‘Šé—®é¢˜</span>
              </div>
            </div>
          </div>
        </section>
        <section id="teacher-salary-section">
          <div class="content-card">
            <h2><i class="fas fa-chalkboard-teacher"></i> æ•™å¸ˆå·¥èµ„ç®¡ç†</h2>
            <div class="status-container">
              <div id="teacherContractStatus" class="status-message">
                <span>åˆçº¦çŠ¶æ€: </span>
                <span id="teacherContractAddress">æœªè¿æ¥</span>
              </div>
              <div class="contract-balance-info">
                <div id="teacherContractBalance" class="balance-display">åˆçº¦ä½™é¢: åŠ è½½ä¸­...</div>
                <button onclick="getTeacherContractBalance()" class="refresh-button">
                  <i class="fas fa-sync-alt"></i> åˆ·æ–°ä½™é¢
                </button>
              </div>
            </div>
        
            <!-- ç®¡ç†å‘˜åŠŸèƒ½åŒº -->
            <div class="admin-section">
              <h3><i class="fas fa-user-shield"></i> ç®¡ç†å‘˜åŠŸèƒ½</h3>
              <div class="form-group">
                <label for="teacherAddress">æ•™å¸ˆé’±åŒ…åœ°å€:</label>
                <input type="text" id="teacherAddress" placeholder="0x..." class="text-input">
              </div>
              <div class="form-group">
                <label for="teacherSalary">å·¥èµ„é‡‘é¢ (ETH):</label>
                <input type="number" id="teacherSalary" step="0.001" min="0" class="text-input">
              </div>
              <div class="button-container">
                <button onclick="addTeacher()" class="primary-button">æ·»åŠ æ•™å¸ˆ</button>
                <button onclick="removeTeacher()" class="danger-button">ç§»é™¤æ•™å¸ˆ</button>
              </div>
              <div id="adminActionStatus" class="status-message"></div>
        
              <div class="form-group mt-4">
                <label for="depositAmount">å­˜å…¥é‡‘é¢ (ETH):</label>
                <input type="number" id="depositAmount" step="0.001" min="0" class="text-input">
              </div>
              <div class="button-container">
                <button onclick="depositToContract()" class="primary-button">å­˜å…¥åˆçº¦</button>
              </div>
              <div id="depositStatus" class="status-message"></div>
            </div>
        
            <!-- æ•™å¸ˆåˆ—è¡¨ -->
            <div class="teacher-list-section mt-4">
              <h3><i class="fas fa-list"></i> æ•™å¸ˆåˆ—è¡¨</h3>
              <button onclick="loadTeacherList()" class="secondary-button">
                <i class="fas fa-sync-alt"></i> åˆ·æ–°åˆ—è¡¨
              </button>
              <div id="teacherList" class="data-table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>æ•™å¸ˆåœ°å€</th>
                      <th>å·¥èµ„(ETH)</th>
                      <th>ä¸‹æ¬¡å‘æ”¾æ—¶é—´</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody id="teacherListBody">
                    <!-- æ•™å¸ˆæ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                  </tbody>
                </table>
              </div>
            </div>
        
            <!-- æ•™å¸ˆåŠŸèƒ½åŒº -->
            <div class="teacher-section mt-4">
              <h3><i class="fas fa-hand-holding-usd"></i> æ•™å¸ˆå·¥èµ„é¢†å–</h3>
              <div class="form-group">
                <label for="salaryTeacherAddress">æ•™å¸ˆåœ°å€:</label>
                <input type="text" id="salaryTeacherAddress" placeholder="0x..." class="text-input">
              </div>
              <div class="button-container">
                <button onclick="paySalary()" class="primary-button">é¢†å–å·¥èµ„</button>
                <button onclick="checkPaymentTime()" class="secondary-button">æŸ¥è¯¢å¯é¢†å–çŠ¶æ€</button>
              </div>
              <div id="paymentStatus" class="status-message"></div>
            </div>
          </div>
        </section>
        <!-- ... ç°æœ‰ä»£ç  ... -->
        
        <!-- åœ¨bodyç»“æŸæ ‡ç­¾å‰æ·»åŠ æ•™å¸ˆå·¥èµ„ç®¡ç†çš„è„šæœ¬ -->
        <script src="teacher-salary.js"></script>



        <!-- ç³»ç»Ÿç®¡ç†éƒ¨åˆ† -->
        <section id="system-section">
          <div class="content-card">
            <h2><i class="fas fa-user-shield"></i> è´¦æˆ·ä¿¡æ¯</h2>
            <button onclick="getAccountInfo()">è·å–å½“å‰è´¦æˆ·ä¿¡æ¯</button>
            <div id="accountAddress"></div>
            <div id="accountBalance"></div>
          </div>

          <div class="content-card">
            <h2><i class="fas fa-exchange-alt"></i> äº¤æ˜“æŸ¥è¯¢</h2>
            <div class="form-group">
              <label for="txHashInput">äº¤æ˜“å“ˆå¸Œ:</label>
              <input type="text" id="txHashInput" placeholder="è¯·è¾“å…¥äº¤æ˜“å“ˆå¸Œ">
            </div>
            
            <button onclick="getTransactionInfo()">æŸ¥è¯¢äº¤æ˜“</button>
            <pre id="transactionInfo"></pre>
          </div>

          <div class="content-card">
            <h2><i class="fas fa-cloud-upload-alt"></i> å›¾ç‰‡ä¸Šä¼ </h2>
            <div class="form-group">
              <label for="imageInput">é€‰æ‹©å›¾ç‰‡:</label>
              <input type="file" id="imageInput" accept="image/*" onchange="previewImage(event)">
            </div>
            
            <div id="imagePreview"></div>
            <button onclick="uploadImageToPinata()">ä¸Šä¼ åˆ°IPFS</button>
            <div id="pinataResponse"></div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
  <button class="sidebar-toggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- è„šæœ¬å¼•ç”¨ -->
  <script src="../scr/script.js"></script>
  <script src="../scr/script1.js"></script>
  <script src="../scr/script2.js"></script>
  <script src="../scr/script3.js"></script>
  <script src="../scr/script4.js"></script>
  <!-- æ·»åŠ AIèŠå¤©è„šæœ¬ -->
  <script src="../scr/ai-chat.js"></script>
 
  <script>
    // æ£€æŸ¥åŒºå—é“¾è¿æ¥
    async function checkBlockchainConnection() {
      const blockchainIcon = document.getElementById('blockchainIcon');
      const blockchainStatusText = document.getElementById('blockchainStatusText');

      blockchainIcon.textContent = 'ğŸ”„';
      blockchainIcon.className = 'status-icon connecting';
      blockchainStatusText.textContent = 'æ­£åœ¨è¿æ¥...';
      blockchainStatusText.className = 'connecting';

      try {
        if (window.ethereum) {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            blockchainIcon.textContent = 'âœ…';
            blockchainIcon.className = 'status-icon connected';
            blockchainStatusText.textContent = 'å·²è¿æ¥';
            blockchainStatusText.className = 'connected';
          } else {
            throw new Error('æœªæˆæƒè®¿é—®è´¦æˆ·');
          }
        } else {
          throw new Error('æœªæ£€æµ‹åˆ°ä»¥å¤ªåŠæä¾›è€…');
        }
      } catch (error) {
        console.error('åŒºå—é“¾è¿æ¥æ£€æŸ¥å¤±è´¥:', error);
        blockchainIcon.textContent = 'âŒ';
        blockchainIcon.className = 'status-icon disconnected';
        blockchainStatusText.textContent = 'è¿æ¥å¤±è´¥';
        blockchainStatusText.className = 'disconnected';
      }
    }

    // ç”Ÿæˆç­çº§ç»Ÿè®¡
    async function generateClassStats() {
      const className = document.getElementById('statsClassName').value.trim();
      if (!className) {
        alert('è¯·è¾“å…¥ç­çº§åç§°');
        return;
      }

      try {
        // è·å–ç­çº§å­¦ç”Ÿåˆ—è¡¨
        const response = await fetch(`http://localhost:8080/api/student-info/class/${encodeURIComponent(className)}`);
        const result = await response.json();
        
        if (!result.success || !result.data || result.data.length === 0) {
          alert(`æœªæ‰¾åˆ°ç­çº§ "${className}" çš„å­¦ç”Ÿ`);
          return;
        }

        // è·å–å­¦ç”Ÿæˆç»©
        const students = result.data;
        const gradesData = [];
        
        for (const student of students) {
          try {
            const result = await contract.methods.get(parseInt(student.student_id)).call();
            if (result && result[0]) {
              const subjectNames = result[1];
              const scores = result[2];
              
              // æ·»åŠ åˆ°æˆç»©æ•°æ®
              for (let i = 0; i < subjectNames.length; i++) {
                gradesData.push({
                  studentId: student.student_id,
                  name: student.name,
                  subject: subjectNames[i],
                  score: parseInt(scores[i])
                });
              }
            }
          } catch (error) {
            console.error(`è·å–å­¦ç”Ÿ ${student.student_id} æˆç»©å¤±è´¥:`, error);
          }
        }
        
        if (gradesData.length === 0) {
          alert(`ç­çº§ "${className}" æš‚æ— æˆç»©æ•°æ®`);
          return;
        }
        
        // ç”Ÿæˆç»Ÿè®¡å›¾è¡¨
        generateCharts(className, gradesData);
        
      } catch (error) {
        console.error('ç”Ÿæˆç­çº§ç»Ÿè®¡å¤±è´¥:', error);
        alert('ç”Ÿæˆç­çº§ç»Ÿè®¡å¤±è´¥: ' + error.message);
      }
    }

    // ç”Ÿæˆç»Ÿè®¡å›¾è¡¨
    function generateCharts(className, gradesData) {
      const chartsContainer = document.getElementById('chartsContainer');
      chartsContainer.innerHTML = '';
      
      // åˆ›å»ºå›¾è¡¨å®¹å™¨
      const subjectStatsDiv = document.createElement('div');
      subjectStatsDiv.style.width = '100%';
      subjectStatsDiv.style.height = '400px';
      subjectStatsDiv.style.marginBottom = '30px';
      
      const studentStatsDiv = document.createElement('div');
      studentStatsDiv.style.width = '100%';
      studentStatsDiv.style.height = '400px';
      
      chartsContainer.appendChild(subjectStatsDiv);
      chartsContainer.appendChild(studentStatsDiv);
      
      // æŒ‰ç§‘ç›®ç»Ÿè®¡
      const subjectStats = {};
      gradesData.forEach(item => {
        if (!subjectStats[item.subject]) {
          subjectStats[item.subject] = {
            scores: [],
            total: 0,
            count: 0
          };
        }
        
        subjectStats[item.subject].scores.push(item.score);
        subjectStats[item.subject].total += item.score;
        subjectStats[item.subject].count++;
      });
      
      // è®¡ç®—å¹³å‡åˆ†
      Object.keys(subjectStats).forEach(subject => {
        subjectStats[subject].average = subjectStats[subject].total / subjectStats[subject].count;
      });
      
      // åˆ›å»ºç§‘ç›®å¹³å‡åˆ†å›¾è¡¨
      const subjectChart = echarts.init(subjectStatsDiv);
      const subjectOption = {
        title: {
          text: `${className} ç­çº§å„ç§‘ç›®å¹³å‡åˆ†`,
          left: 'center'
        },
        tooltip: {
          trigger: 'axis',
          formatter: '{b}: {c}åˆ†'
        },
        xAxis: {
          type: 'category',
          data: Object.keys(subjectStats)
        },
        yAxis: {
          type: 'value',
          min: 0,
          max: 100,
          name: 'åˆ†æ•°'
        },
        series: [{
          data: Object.keys(subjectStats).map(subject => subjectStats[subject].average.toFixed(2)),
          type: 'bar',
          showBackground: true,
          backgroundStyle: {
            color: 'rgba(180, 180, 180, 0.2)'
          },
          itemStyle: {
            color: '#1a73e8'
          },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}åˆ†'
          }
        }]
      };
      
      subjectChart.setOption(subjectOption);
      
      // æŒ‰å­¦ç”Ÿç»Ÿè®¡
      const studentStats = {};
      gradesData.forEach(item => {
        const key = `${item.studentId}-${item.name}`;
        if (!studentStats[key]) {
          studentStats[key] = {
            scores: [],
            total: 0,
            count: 0,
            name: item.name
          };
        }
        
        studentStats[key].scores.push(item.score);
        studentStats[key].total += item.score;
        studentStats[key].count++;
      });
      
      // è®¡ç®—å­¦ç”Ÿå¹³å‡åˆ†
      Object.keys(studentStats).forEach(key => {
        studentStats[key].average = studentStats[key].total / studentStats[key].count;
      });
      
      // åˆ›å»ºå­¦ç”Ÿå¹³å‡åˆ†å›¾è¡¨
      const studentChart = echarts.init(studentStatsDiv);
      const studentOption = {
        title: {
          text: `${className} ç­çº§å­¦ç”Ÿå¹³å‡åˆ†`,
          left: 'center'
        },
        tooltip: {
          trigger: 'axis',
          formatter: '{b}: {c}åˆ†'
        },
        xAxis: {
          type: 'category',
          data: Object.keys(studentStats).map(key => studentStats[key].name),
          axisLabel: {
            interval: 0,
            rotate: 30
          }
        },
        yAxis: {
          type: 'value',
          min: 0,
          max: 100,
          name: 'åˆ†æ•°'
        },
        series: [{
          data: Object.keys(studentStats).map(key => studentStats[key].average.toFixed(2)),
          type: 'bar',
          showBackground: true,
          backgroundStyle: {
            color: 'rgba(180, 180, 180, 0.2)'
          },
          itemStyle: {
            color: '#4caf50'
          },
          label: {
            show: true,
            position: 'top',
            formatter: '{c}åˆ†'
          }
        }]
      };
      
      studentChart.setOption(studentOption);
      
      // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
      window.addEventListener('resize', function() {
        subjectChart.resize();
        studentChart.resize();
      });
    }
  </script>
</body>
</html>
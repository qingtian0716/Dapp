(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=e(o);fetch(o.href,i)}})();const u={"/":{auth:!1},"/login":{auth:!1},"/admin":{auth:!0,role:"admin"},"/teacher":{auth:!0,role:"teacher"},"/student":{auth:!0,role:"student"},"/error":{auth:!1}};class w{constructor(){this.routes=u,this.currentRoute=null,this.redirectCount=0,this.maxRedirects=10,this.currentPath=sessionStorage.getItem("currentPath")||window.location.pathname,this.errorHandler=this.handleError.bind(this)}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.initRouteHandling()):this.initRouteHandling(),document.addEventListener("click",t=>{const e=t.target.closest("a");if(e&&e.href.startsWith(window.location.origin)){t.preventDefault();const s=e.pathname;this.navigate(s)}})}initRouteHandling(){window.addEventListener("popstate",t=>{var e;this.handleRoute(((e=t.state)==null?void 0:e.path)||window.location.pathname)}),this.handleRoute(this.currentPath)}register(t,e){this.routes[t]=e}removePageScripts(){document.querySelectorAll("script[data-page-script]").forEach(e=>e.parentNode.removeChild(e))}loadPageScript(t){const e=t.replace(/^\/+/,"").split("/")[0];if(!(!e||document.querySelector(`script[src="../scripts/${e}.js"]`)))try{const o=document.createElement("script");o.src=`../scripts/${e}.js`,o.type="module",o.setAttribute("data-page-script",e),document.body.appendChild(o),console.log(`已加载页面脚本: ${e}.js`)}catch(o){console.warn(`加载页面脚本失败: ${e}.js`,o)}}triggerRouteChanged(t,e){window.dispatchEvent(new CustomEvent("routeChanged",{detail:{path:t,component:e}}))}checkAuth(t){const e=this.routes[t];if(!e)return{allowed:!0};if(!e.auth)return{allowed:!0};const s=localStorage.getItem("jwtToken"),o=localStorage.getItem("userRole"),i=localStorage.getItem("walletAddress"),n=window.location.pathname;if(!s||!i)return n==="/login"?{allowed:!0}:{allowed:!1,redirectTo:`/login?redirect=${encodeURIComponent(n)}`,message:"请先连接钱包并登录系统"};if(e.role){if(!o)return{allowed:!1,redirectTo:"/error",message:"用户角色信息缺失"};if(o!==e.role)return{allowed:!1,redirectTo:"/error",message:`权限不足: 需要${e.role}角色`,status:403}}return{allowed:!0}}async handleRoute(t){try{if(this.redirectCount>=this.maxRedirects)return this.handleError("检测到过多重定向，已停止路由处理");if(t===this.currentPath){console.log("路径未变化，不重新加载");return}let e=this.normalizePath(t);this.currentPath=e,sessionStorage.setItem("currentPath",e);const s=document.getElementById("app");if(!s)return this.handleError("找不到app元素，请确保HTML文件中包含id为app的div元素");s.innerHTML="",this.removePageScripts();const o=this.checkAuth(e);if(!o.allowed)return this.navigate(o.redirectTo);if(e==="/"){const n=localStorage.getItem("jwtToken"),a=localStorage.getItem("userRole");if(n&&a==="admin"&&window.location.pathname!=="/admin")return this.navigate("/admin");{const l=await fetch("/html/index.html");if(l.ok){const c=await l.text();s.innerHTML=c,this.triggerRouteChanged("/","index");return}else throw new Error("加载首页失败")}}if(this.routes[e])try{let n=`${e}.html`;e==="/"&&(n="/index.html");const a=await fetch(n);if(a.ok){const l=await a.text();s.innerHTML=l,this.triggerRouteChanged(e,e.substring(1)),this.loadPageScript(e)}else throw new Error(`页面不存在: ${n}`)}catch(n){this.handleError(n.message||"页面加载错误")}else{let n=`${e}.html`,a;try{if(a=await fetch(n),!a.ok){const c=`/${e.split("/").pop()||"index"}.html`,d=await fetch(c);d.ok&&(a=d,n=c)}if(a.ok){const l=await a.text();s.innerHTML=l,this.triggerRouteChanged(e,e.substring(1)),window.location.pathname.replace(/\.html$/,"")!==e&&window.history.replaceState({path:e},"",e),this.loadPageScript(e)}else throw new Error(`页面不存在: ${n}`)}catch(l){this.handleError(l.message||"路由加载失败")}}}catch(e){this.handleError(e.message||"路由处理错误")}}async navigate(t){if(!t)return console.error("导航路径不能为空"),!1;try{return t===this.currentPath&&!t.includes("?forceRefresh=true")?(console.log("路径未变化，不重新加载"),!0):(window.history.pushState({path:t},"",t),await this.handleRoute(t),!0)}catch(e){return console.error("导航错误:",e),this.handleError(e.message||"导航错误"),!1}}getCurrentPath(){return this.currentPath}redirect(t,e){const s=e?`${t}?message=${encodeURIComponent(e)}`:t;window.location.href=s}normalizePath(t){let e=t.replace(/^\/?html\/?/,"/").replace(/\.html$/,"").replace(/^\/?admin$/,"/admin").replace(/^\/?login$/,"/login").replace(/^\/?teacher$/,"/teacher").replace(/^\/?student$/,"/student");return e.startsWith("/")?e:"/"+e}async handleError(t,e=null){console.error("路由错误:",t,e),this.redirectCount=0,this.currentRoute=null,sessionStorage.setItem("routeError",JSON.stringify({message:t,timestamp:new Date().toISOString()}));try{const s=await fetch("/html/error.html");if(s.ok){const o=await s.text(),i=document.getElementById("app");if(i){i.innerHTML=o;const n=document.querySelector(".error-message");n&&(n.textContent=t)}this.triggerRouteChanged("/error","error")}}catch(s){console.error("加载错误页面失败:",s);const o=document.getElementById("app");o&&(o.innerHTML=`
                <div class="error-page">
                  <div class="error-container">
                    <h2 class="error-title">系统错误</h2>
                    <p class="error-message">${t}</p>
                    <button onclick="window.location.href='/'">返回首页</button>
                  </div>
                </div>
              `)}}}function y(r,t=""){console.error(t||"操作失败:",r);let e=t||"操作失败";return r&&r.message&&(e+=": "+r.message),h(e,"error"),!1}function h(r,t="info"){try{const e=m();if(!e){console.error("无法创建通知元素");return}p(e,r),f(e,t),g(e)}catch(e){console.error("显示通知失败:",e)}}function m(){let r=document.getElementById("toast-notification");return r||(r=document.createElement("div"),r.id="toast-notification",r.style.position="fixed",r.style.bottom="20px",r.style.right="20px",r.style.padding="12px 20px",r.style.borderRadius="4px",r.style.color="white",r.style.zIndex="9999",r.style.transition="all 0.3s ease-in-out",r.style.opacity="0",r.style.transform="translateY(20px)",r.style.boxShadow="0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23)",r.style.fontFamily="Arial, sans-serif",document.body.appendChild(r)),r}function p(r,t){r.textContent=t}function f(r,t){const e={info:"#2196F3",success:"#4CAF50",warning:"#FF9800",error:"#F44336"};r.style.backgroundColor=e[t]||e.info}function g(r){r.style.opacity="1",r.style.transform="translateY(0)",setTimeout(()=>{r.style.opacity="0",r.style.transform="translateY(20px)",setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},300)},3e3)}export{w as R,y as h,h as s};

import{s}from"./error-DxBeLxpQ.js";import{i as g,c as f,a as y,w as u,b as k,s as S,W as B}from"./transactionHelper-CcnemSdY.js";import{g as E}from"./web3Utils-CLO0_VA5.js";const t={connectWalletBtn:document.getElementById("connectWalletBtn"),roleSelection:document.getElementById("roleSelection"),studentRoleBtn:document.getElementById("studentRoleBtn"),teacherRoleBtn:document.getElementById("teacherRoleBtn"),adminRoleBtn:document.getElementById("adminRoleBtn"),networkIndicator:document.getElementById("networkIndicator")};function d(e,n=""){var a;console.error(n||"操作失败:",e);const o=B.handleContractError(e)||(n?`${n}: ${e.message}`:e.message);return s(o,(a=e.message)!=null&&a.includes("User denied")?"warning":"error"),!1}async function p(){var e;try{P();const n=localStorage.getItem("lastConnectedAddress"),o=localStorage.getItem("userRole");n&&o?await g()&&((e=f)==null?void 0:e.toLowerCase())===n.toLowerCase()?(await m(o,!0),await w()):(localStorage.removeItem("userRole"),localStorage.removeItem("lastConnectedAddress"),t.roleSelection&&(t.roleSelection.style.display="none")):t.networkIndicator&&(t.networkIndicator.textContent="未连接",t.networkIndicator.className="network-indicator disconnected")}catch(n){d(n,"页面初始化失败")}}async function m(e,n=!1){try{if(!u)return s("请先连接钱包","warning"),!1;if(!k)return s("智能合约未初始化，请先连接钱包","warning"),!1;if(!await h(f,e))return s("登录失败，请重试","error"),!1;const a=await S(e);return a&&(n||s(`已选择${e}角色`,"success"),setTimeout(()=>{switch(e){case"student":window.location.href="student.html";break;case"teacher":window.location.href="teacher.html";break;case"admin":window.location.href="admin.html";break;default:console.error("未知角色:",e)}},1e3)),a}catch(o){return d(o,`选择${e}角色失败`)}}async function h(e,n){try{if(!e)throw new Error("钱包地址不能为空");const a=`${window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://localhost:8080":window.location.origin}/api/auth/wallet-login`;console.log("正在请求API:",a);try{const r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({walletAddress:e}),credentials:"include"});if(r.status===405)return s("API服务器方法不允许，请检查服务器配置","error"),!1;let c;try{c=await r.json()}catch(l){return console.error("解析API响应失败:",l),s("API响应格式错误","error"),!1}if(!r.ok){if(r.status===404)return await A(e,n);throw new Error(c.message||"登录失败")}if(c.success&&c.data){const{token:l,refreshToken:i,expiresIn:I}=c.data;return localStorage.setItem("jwtToken",l),localStorage.setItem("refreshToken",i),localStorage.setItem("tokenExpiry",(Date.now()+I*1e3).toString()),localStorage.setItem("userRole",n),localStorage.setItem("walletAddress",e),!0}return!1}catch(r){return console.error("API请求失败:",r),s(`API请求失败: ${r.message}`,"error"),!1}}catch(o){return console.error("API登录失败:",o),s(`登录失败: ${o.message}`,"error"),!1}}async function A(e,n){try{const a=`${window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?"http://localhost:8080":window.location.origin}/api/auth/register`;console.log("正在请求注册API:",a);try{const r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({walletAddress:e,role:n}),credentials:"include"});if(r.status===405)return s("API服务器方法不允许，请检查服务器配置","error"),!1;let c;try{c=await r.json()}catch(l){return console.error("解析API响应失败:",l),s("API响应格式错误","error"),!1}if(!r.ok)throw new Error(c.message||"注册失败");return await h(e,n)}catch(r){return console.error("API请求失败:",r),s(`API请求失败: ${r.message}`,"error"),!1}}catch(o){return console.error("用户注册失败:",o),s("注册失败: "+o.message,"error"),!1}}async function w(){try{if(!u)return console.log("Web3未初始化，无法获取网络状态"),t.networkIndicator&&(t.networkIndicator.textContent="未连接",t.networkIndicator.className="network-indicator disconnected"),!1;try{const e=await E(),n=e.networkType?`${e.networkType} (${e.chainId})`:"已连接";return console.log("当前网络:",n),t.networkIndicator&&(t.networkIndicator.textContent=n,t.networkIndicator.className="network-indicator connected"),!0}catch(e){return console.warn("获取网络信息失败:",e),t.networkIndicator&&(t.networkIndicator.textContent="网络错误",t.networkIndicator.className="network-indicator error"),!1}}catch(e){return t.networkIndicator&&(t.networkIndicator.textContent="状态未知",t.networkIndicator.className="network-indicator disconnected"),d(e,"获取网络状态失败")}}function P(){var n,o,a,r;t.connectWalletBtn&&t.connectWalletBtn.addEventListener("click",async()=>{try{t.connectWalletBtn.disabled=!0,await y()&&(localStorage.setItem("lastConnectedAddress",f),t.roleSelection&&(t.roleSelection.style.display="block"),await w())}catch(c){d(c,"连接钱包失败")}finally{t.connectWalletBtn.disabled=!1}});const e={student:t.studentRoleBtn,teacher:t.teacherRoleBtn,admin:t.adminRoleBtn};Object.entries(e).forEach(([c,l])=>{l&&l.addEventListener("click",async()=>{Object.values(e).forEach(i=>{i&&(i.disabled=!0)});try{await m(c)}catch(i){d(i,`选择${c}角色失败`)}finally{Object.values(e).forEach(i=>{i&&(i.disabled=!1)})}})}),window.ethereum&&((o=(n=window.ethereum).removeAllListeners)==null||o.call(n,"accountsChanged"),(r=(a=window.ethereum).removeAllListeners)==null||r.call(a,"chainChanged"),window.ethereum.on("accountsChanged",()=>{localStorage.removeItem("lastConnectedAddress"),localStorage.removeItem("userRole"),t.roleSelection&&(t.roleSelection.style.display="none"),t.connectWalletBtn&&(t.connectWalletBtn.disabled=!1),w()}),window.ethereum.on("chainChanged",()=>{window.location.reload()}))}document.addEventListener("DOMContentLoaded",p);

import{s as l}from"./error-DxBeLxpQ.js";import{b as o,w as d,c as f,d as p,W as y,f as g}from"./transactionHelper-CcnemSdY.js";import{c as v,a as A}from"./web3Utils-CLO0_VA5.js";const T=window.location.hostname==="localhost"?"http://localhost:8080":window.location.origin,c=v(5*60*1e3),i={isLoading:!1,transactionQueue:new Set,setLoading(e){this.isLoading=e,document.querySelectorAll(".loading-indicator").forEach(t=>{t.style.display=e?"block":"none"})},addToQueue(e){this.transactionQueue.add(e),this.updateTransactionStatus()},removeFromQueue(e){this.transactionQueue.delete(e),this.updateTransactionStatus()},updateTransactionStatus(){const e=this.transactionQueue.size>0;document.querySelectorAll(".tx-pending").forEach(t=>{t.style.display=e?"inline":"none"})}},h=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),L=e=>{if(!d.utils.isAddress(e))throw new Error("无效的钱包地址");if(e.toLowerCase()===f.toLowerCase())throw new Error("不能操作自己的账户")};async function b(){var e,t;try{if(!((e=d)!=null&&e.currentProvider))throw new Error("Web3未初始化");if(!((t=o)!=null&&t.methods))throw new Error("合约未初始化");const[r,n]=await Promise.all([o.methods.admin().call(),y.getCurrentAccount()]);if(!n)throw new Error("未检测到钱包账户");if(n.toLowerCase()!==r.toLowerCase())throw new Error("只有管理员可以执行此操作");return!0}catch(r){return w(r),!1}}async function E(){const e=Symbol("addTeacher");try{if(i.addToQueue(e),!await b())return;const t=document.getElementById("teacherAddress").value.trim();L(t),await C(t),document.getElementById("teacherAddress").value="",c.clear()}catch(t){w(t)}finally{i.removeFromQueue(e)}}async function C(e){const t=await g(e,async()=>{await k(e),await u()});l(t.success?"操作成功":"操作失败",t.success?"success":"error")}async function k(e){const t=await fetch(`${T}/api/teachers`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({walletAddress:e,roleId:2,status:"active"})});if(!t.ok){const r=await t.json();throw new Error(r.message||"保存教师信息失败")}}async function u(){try{i.setLoading(!0);const t=c.isExpired()?null:c.getData();if(t)m(t);else{const r=await S();c.update(r),m(r)}}catch(e){console.error("加载教师列表失败:",e),l("无法加载教师列表，请检查网络连接","error"),x()}finally{i.setLoading(!1)}}async function S(){try{const[e,t]=await Promise.all([o.methods.admin().call(),o.getPastEvents("TeacherAdded",{fromBlock:0})]),r=await Promise.all(t.map(async n=>{var a;try{const s=(a=n.returnValues)==null?void 0:a.teacher;return!s||!d.utils.isAddress(s)?null:await o.methods.teachers(s).call()?s:null}catch{return null}}));return{adminAddress:e||"",teachers:r.filter(Boolean)}}catch(e){return console.error("获取教师数据失败:",e),{adminAddress:"",teachers:[]}}}function m(e){const t=document.getElementById("teacherList");if(!t)return;const r=Array.isArray(e==null?void 0:e.teachers)?e.teachers:[],n=(e==null?void 0:e.adminAddress)||"";if(r.length===0){t.innerHTML='<div class="no-teachers">暂无教师信息</div>';return}t.innerHTML=r.map(a=>{const s=a.toLowerCase()===n.toLowerCase();return`
      <div class="teacher-item">
        <span class="address">${h(a)}</span>
        ${s?"":`
          <button class="btn-remove" onclick="removeTeacher('${h(a)}')">移除</button>
        `}
      </div>
    `}).join("")}function w(e){const t={"User denied transaction":"用户取消了交易","Only admin":"需要管理员权限","Teacher exists":"该地址已是教师",Web3未初始化:"请检查钱包连接状态",contract未初始化:"智能合约加载失败",未检测到钱包账户:"请先连接钱包账户",获取账户信息失败:"无法获取账户信息","Invalid address":"无效的钱包地址","Returned error":"合约调用失败",MetaMask:"请检查MetaMask状态","Network Error":"网络连接异常"};let r="操作失败，请检查控制台";const n=t[e.message];if(n)r=n;else{const a=Object.entries(t).find(([s])=>e.message.toLowerCase().includes(s.toLowerCase()));a&&(r=a[1])}l(r,"error"),console.error("合约错误:",{message:e.message,code:e.code,stack:e.stack})}function I(){var e,t;(e=document.querySelector("#addTeacherBtn"))==null||e.addEventListener("click",E),(t=document.querySelector("#refreshBtn"))==null||t.addEventListener("click",u)}async function M(){await A(),I(),await u(),p()}function P(){const e=document.createElement("div");e.style="position:fixed;bottom:0;right:0;background:#222;color:#fff;padding:10px;z-index:10000;",setInterval(()=>{var r,n;const t={Web3Connected:!!((r=d)!=null&&r.currentProvider),ContractInitialized:!!((n=o)!=null&&n.methods),CurrentAccount:f,CacheStatus:c.status()};e.innerHTML=`<strong>系统监控面板</strong><pre>${JSON.stringify(t,null,2)}</pre>`},2e3),document.body.appendChild(e)}function x(){const e=document.getElementById("teacherList");e&&(e.innerHTML=`
    <div class="error-state">
      <h4>数据加载异常</h4>
      <ul>
        <li>检查网络连接</li>
        <li>刷新页面</li>
        <li>确认钱包已连接</li>
      </ul>
      <button onclick="location.reload()">立即刷新</button>
    </div>
  `)}document.addEventListener("DOMContentLoaded",()=>{P(),M()});

import{s as o}from"./error-DxBeLxpQ.js";import{b as d,w as m,i as b,W as P,c as L}from"./transactionHelper-CcnemSdY.js";const i={studentId:null,studentName:null,isLoading:!1},s={currentPage:1,pageSize:10,total:0,totalPages:0},n={scores:{data:null,timestamp:null,expirationTime:5*60*1e3},studentInfo:{data:null,timestamp:null,expirationTime:30*60*1e3}};async function l(){return(!m||!d)&&!await b()?(o("请先连接钱包","warning"),!1):(await m.eth.getAccounts()).length===0?(o("请先连接钱包","warning"),!1):!0}async function x(t){try{return await l()?!!await d.methods.getStudentInfo(t).call():!1}catch(e){return console.error("身份验证失败:",e),!1}}async function E(){try{if(!await l())return;const t=document.getElementById("queryStudentId").value;if(!t||isNaN(t)){o("请输入有效的学号","warning");return}const e=Date.now();if(n.studentInfo.data&&n.studentInfo.data.id===t&&n.studentInfo.timestamp&&e-n.studentInfo.timestamp<n.studentInfo.expirationTime){f(n.studentInfo.data);return}const a=await d.methods.getStudentInfo(t).call(),r={id:t,name:a};n.studentInfo.data=r,n.studentInfo.timestamp=e,f(r),o("学生信息获取成功","success")}catch(t){g(t)}}function f(t){document.getElementById("infoId").textContent=t.id,document.getElementById("infoName").textContent=t.name}async function w(){if(!(i.isLoading||!await l()))try{i.isLoading=!0;const t=document.getElementById("myScoreList");if(t.innerHTML="",!await N())return;const e=Date.now();if(n.scores.data&&n.scores.timestamp&&e-n.scores.timestamp<n.scores.expirationTime){p(n.scores.data),o("已加载缓存的成绩数据","info");return}const a=await fetch(`/api/scores?studentId=${i.studentId}&page=${s.currentPage}&limit=${s.pageSize}`);if(!a.ok)throw new Error("获取成绩数据失败");const r=await a.json();if(!r.success)throw new Error(r.message||"获取成绩失败");const{data:c,pagination:u}=r.data;Object.assign(s,{total:u.total,totalPages:u.totalPages,currentPage:u.currentPage});const I=c.reduce((S,{score:h})=>S+h,0),y=c.length>0?(I/c.length).toFixed(2):"-";n.scores.data=c,n.scores.timestamp=e,document.getElementById("lastUpdateTime").textContent=new Date(e).toLocaleString(),document.getElementById("averageScore").textContent=y,document.getElementById("subjectCount").textContent=c.length,p(c),C(),o("成绩加载完成","success")}catch(t){g(t)}finally{i.isLoading=!1}}async function N(){if(i.studentId)return!0;let t=localStorage.getItem("studentId");return!t&&(t=prompt("请输入您的学号:",""),!t||isNaN(t))?(o("请输入有效的学号","warning"),!1):await x(t)?(i.studentId=t,localStorage.setItem("studentId",t),!0):await $(t)?(i.studentId=t,!0):!1}async function $(t){if(!confirm("该学号未注册,是否立即注册？"))return!1;const a=prompt("请输入您的姓名:");if(!a)return!1;try{return await d.methods.registerStudent(t,a).send({from:L}),o("注册成功！","success"),!0}catch(r){return g(r),!1}}function p(t){const e=document.getElementById("myScoreList");if(!t||t.length===0){e.innerHTML=`
            <tr>
                <td colspan="3" style="text-align: center;">暂无成绩数据</td>
            </tr>
        `;return}const a=t.map(({subject:r,score:c,timestamp:u})=>`
        <tr>
            <td>${r}</td>
            <td>${c}</td>
            <td>${new Date(u).toLocaleString()}</td>
        </tr>
    `).join("");e.innerHTML=a}function C(){const t=document.createElement("div");t.className="pagination",t.innerHTML=`
        <button class="page-btn" ${s.currentPage===1?"disabled":""} onclick="changePage(${s.currentPage-1})">
            上一页
        </button>
        <span class="page-info">${s.currentPage} / ${s.totalPages}</span>
        <button class="page-btn" ${s.currentPage===s.totalPages?"disabled":""} onclick="changePage(${s.currentPage+1})">
            下一页
        </button>
    `;const e=document.getElementById("myScoreTable"),a=document.querySelector(".pagination");a?a.replaceWith(t):e.parentNode.insertBefore(t,e.nextSibling)}async function T(t){t<1||t>s.totalPages||s.currentPage===t||(s.currentPage=t,await w())}function B(){if(!n.scores.data){o("暂无成绩数据可导出","warning");return}const t=[["科目","分数","录入时间"].join(","),...n.scores.data.map(({subject:r,score:c,timestamp:u})=>[r,c,new Date(u).toLocaleString()].join(","))].join(`
`),e=new Blob([t],{type:"text/csv;charset=utf-8;"}),a=document.createElement("a");a.href=URL.createObjectURL(e),a.download=`成绩单_${i.studentId}_${new Date().toLocaleDateString()}.csv`,a.click()}function j(){n.scores.data=null,n.scores.timestamp=null,o("成绩缓存已清除","success")}function g(t){const e=P.handleContractError(t);o(e,t.message.includes("User denied transaction")?"warning":"error"),t.message.includes("Student not found")?o("学生不存在,请检查学号","error"):o(t.message||"操作失败","error")}Object.assign(window,{getMyScores:w,getStudentInfo:E,exportScores:B,clearScoreCache:j,changePage:T});
